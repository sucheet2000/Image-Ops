services:
  redis:
    image: redis:7
    restart: unless-stopped
    volumes:
      - redis_data:/data

  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB is required}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  minio:
    image: quay.io/minio/minio
    command: server /data --console-address ":9001"
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:?S3_ACCESS_KEY is required}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
    volumes:
      - minio_data:/data

  minio-setup:
    image: quay.io/minio/mc
    depends_on:
      - minio
    restart: 'no'
    entrypoint: >
      /bin/sh -c "
      until mc alias set local http://minio:9000 ${S3_ACCESS_KEY:?S3_ACCESS_KEY is required} ${S3_SECRET_KEY:?S3_SECRET_KEY is required}; do sleep 1; done &&
      mc mb --ignore-existing local/${S3_BUCKET:?S3_BUCKET is required}
      "

  api:
    image: ghcr.io/${GHCR_OWNER:-sucheet2000}/image-ops-api:${IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - path: ../.env
        required: false
    environment:
      NODE_ENV: 'production'
      API_PORT: ${API_PORT:-4000}
      WEB_ORIGIN: ${WEB_ORIGIN:-http://localhost:3000}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      JOB_QUEUE_NAME: ${JOB_QUEUE_NAME:-image-ops-jobs}
      JOB_REPO_DRIVER: ${JOB_REPO_DRIVER:-postgres}
      POSTGRES_URL: ${POSTGRES_URL:?POSTGRES_URL is required}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:?S3_BUCKET is required}
      S3_ENDPOINT: ${S3_ENDPOINT:?S3_ENDPOINT is required}
      S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:?S3_ACCESS_KEY is required}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      BILLING_PUBLIC_BASE_URL: ${BILLING_PUBLIC_BASE_URL:-http://localhost:3000}
      BILLING_PORTAL_BASE_URL: ${BILLING_PORTAL_BASE_URL}
    depends_on:
      - redis
      - postgres
      - minio-setup
    ports:
      - '${API_PORT:-4000}:4000'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:4000/ready').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 15s

  worker:
    image: ghcr.io/${GHCR_OWNER:-sucheet2000}/image-ops-worker:${IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - path: ../.env
        required: false
    environment:
      NODE_ENV: 'production'
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      JOB_QUEUE_NAME: ${JOB_QUEUE_NAME:-image-ops-jobs}
      JOB_REPO_DRIVER: 'postgres'
      POSTGRES_URL: ${POSTGRES_URL:?POSTGRES_URL is required}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:?S3_BUCKET is required}
      S3_ENDPOINT: ${S3_ENDPOINT:?S3_ENDPOINT is required}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:?S3_ACCESS_KEY is required}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      BG_REMOVE_API_URL: ${BG_REMOVE_API_URL:-http://127.0.0.1:9999/mock-unused}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-2}
      WORKER_HEARTBEAT_INTERVAL_MS: ${WORKER_HEARTBEAT_INTERVAL_MS:-30000}
    depends_on:
      - redis
      - postgres
      - minio-setup

  web:
    image: ghcr.io/${GHCR_OWNER:-sucheet2000}/image-ops-web:${IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - path: ../.env
        required: false
    environment:
      NODE_ENV: 'production'
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:4000}
    depends_on:
      api:
        condition: service_healthy
    ports:
      - '${WEB_PORT:-3000}:3000'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:3000').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

volumes:
  redis_data:
  postgres_data:
  minio_data:
