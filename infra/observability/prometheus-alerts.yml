groups:
  - name: image-ops-api
    rules:
      - alert: ImageOpsHighAverageLatency
        expr: |
          (
            sum(rate(image_ops_http_request_duration_seconds_total[5m]))
            /
            clamp_min(sum(rate(image_ops_http_requests_total[5m])), 0.001)
          ) > 2
        for: 10m
        labels:
          severity: warning
          service: image-ops-api
        annotations:
          summary: "Image Ops API average latency is high"
          description: "Average HTTP latency has exceeded 2 seconds for 10 minutes."

      - alert: ImageOpsCleanupErrorRate
        expr: |
          sum(rate(image_ops_http_requests_total{path="/api/cleanup",status_code=~"5..|409"}[10m]))
          /
          clamp_min(sum(rate(image_ops_http_requests_total{path="/api/cleanup"}[10m])), 0.001)
          > 0.05
        for: 10m
        labels:
          severity: warning
          service: image-ops-api
        annotations:
          summary: "Image Ops cleanup route error ratio is elevated"
          description: "/api/cleanup 5xx/conflict ratio is above 5% for 10 minutes."

      - alert: ImageOpsQueueDepthHigh
        expr: image_ops_queue_jobs{state="waiting"} > 50
        for: 10m
        labels:
          severity: warning
          service: image-ops-api
        annotations:
          summary: "Image Ops queue waiting depth is high"
          description: "Queue waiting depth has been above 50 for at least 10 minutes."

      - alert: ImageOpsQueueFailuresBacklog
        expr: image_ops_queue_jobs{state="failed"} > 5
        for: 5m
        labels:
          severity: critical
          service: image-ops-api
        annotations:
          summary: "Image Ops failed jobs backlog detected"
          description: "Failed queue backlog is above 5 jobs for 5 minutes."
