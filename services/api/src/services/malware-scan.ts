import { z } from "zod";

export type MalwareScanResult = {
  clean: boolean;
  reason?: string;
};

export interface MalwareScanService {
  scan(input: {
    objectKey: string;
    subjectId: string;
    contentType: string;
    bytes: Buffer;
  }): Promise<MalwareScanResult>;
  close(): Promise<void>;
}

const responseSchema = z.object({
  clean: z.boolean(),
  reason: z.string().optional()
});

export class NoopMalwareScanService implements MalwareScanService {
  async scan(): Promise<MalwareScanResult> {
    return { clean: true };
  }

  async close(): Promise<void> {}
}

export class HttpMalwareScanService implements MalwareScanService {
  constructor(private readonly input: {
    endpointUrl: string;
    timeoutMs: number;
  }) {}

  async scan(input: {
    objectKey: string;
    subjectId: string;
    contentType: string;
    bytes: Buffer;
  }): Promise<MalwareScanResult> {
    const response = await fetch(this.input.endpointUrl, {
      method: "POST",
      headers: {
        "content-type": input.contentType,
        "x-object-key": input.objectKey,
        "x-subject-id": input.subjectId
      },
      body: input.bytes,
      signal: AbortSignal.timeout(this.input.timeoutMs)
    });

    if (!response.ok) {
      const body = await response.text().catch(() => "");
      throw new Error(`Malware scanner returned ${response.status}: ${body}`);
    }

    const payload = await response.json();
    return responseSchema.parse(payload);
  }

  async close(): Promise<void> {}
}
