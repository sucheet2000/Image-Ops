import { afterEach, describe, expect, it } from 'vitest';
import { createHash } from 'node:crypto';
import type { MalwareScanService } from '../src/services/malware-scan';
import { bearerAuthHeaders } from './helpers/auth';
import { createFakeServices, createTestConfig } from './helpers/fakes';
import { startApiTestServer } from './helpers/server';
import { fakePngBytes } from './utils/image-helpers';

const closers: Array<() => Promise<void>> = [];

function sha256Hex(bytes: Buffer): string {
  return createHash('sha256').update(bytes).digest('hex');
}

afterEach(async () => {
  while (closers.length > 0) {
    const close = closers.pop();
    if (close) {
      await close();
    }
  }
});

describe('upload malware scan policy', () => {
  it('blocks uploads flagged by scanner', async () => {
    const services = createFakeServices();
    const config = createTestConfig();
    const scanner: MalwareScanService = {
      async scan() {
        return { clean: false, reason: 'infected-signature' };
      },
      async close() {},
    };
    const server = await startApiTestServer({ ...services, config, malwareScan: scanner });
    closers.push(server.close);

    const objectKey = 'tmp/seller_scan/input/2026/02/23/resize/scan.png';
    const bytes = fakePngBytes('infected');
    services.storage.setObject(objectKey, 'image/png', bytes);

    const response = await fetch(`${server.baseUrl}/api/uploads/complete`, {
      method: 'POST',
      headers: { 'content-type': 'application/json', ...bearerAuthHeaders('seller_scan') },
      body: JSON.stringify({ subjectId: 'seller_scan', objectKey, sha256: sha256Hex(bytes) }),
    });

    expect(response.status).toBe(422);
    const payload = await response.json();
    expect(payload.error).toBe('MALWARE_DETECTED');
  });

  it('fails open when scanner is unavailable and policy allows bypass', async () => {
    const services = createFakeServices();
    const config = {
      ...createTestConfig(),
      malwareScanFailClosed: false,
    };
    const scanner: MalwareScanService = {
      async scan() {
        throw new Error('scanner timeout');
      },
      async close() {},
    };
    const server = await startApiTestServer({ ...services, config, malwareScan: scanner });
    closers.push(server.close);

    const objectKey = 'tmp/seller_scan/input/2026/02/23/resize/bypass.png';
    const bytes = fakePngBytes('clean');
    services.storage.setObject(objectKey, 'image/png', bytes);

    const response = await fetch(`${server.baseUrl}/api/uploads/complete`, {
      method: 'POST',
      headers: { 'content-type': 'application/json', ...bearerAuthHeaders('seller_scan') },
      body: JSON.stringify({ subjectId: 'seller_scan', objectKey, sha256: sha256Hex(bytes) }),
    });

    expect(response.status).toBe(200);
  });
});
