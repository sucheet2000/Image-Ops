import { afterEach, describe, expect, it } from "vitest";
import type { MalwareScanService } from "../src/services/malware-scan";
import { createFakeServices, createTestConfig } from "./helpers/fakes";
import { startApiTestServer } from "./helpers/server";

const closers: Array<() => Promise<void>> = [];

afterEach(async () => {
  while (closers.length > 0) {
    const close = closers.pop();
    if (close) {
      await close();
    }
  }
});

function fakePngBytes(marker: string): Buffer {
  return Buffer.concat([
    Buffer.from([0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a]),
    Buffer.from(marker, "utf8")
  ]);
}

describe("upload malware scan policy", () => {
  it("blocks uploads flagged by scanner", async () => {
    const services = createFakeServices();
    const config = createTestConfig();
    const scanner: MalwareScanService = {
      async scan() {
        return { clean: false, reason: "infected-signature" };
      },
      async close() {}
    };
    const server = await startApiTestServer({ ...services, config, malwareScan: scanner });
    closers.push(server.close);

    const objectKey = "tmp/seller_scan/input/2026/02/23/resize/scan.png";
    services.storage.setObject(objectKey, "image/png", fakePngBytes("infected"));

    const response = await fetch(`${server.baseUrl}/api/uploads/complete`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ subjectId: "seller_scan", objectKey })
    });

    expect(response.status).toBe(422);
    const payload = await response.json();
    expect(payload.error).toBe("MALWARE_DETECTED");
  });

  it("fails open when scanner is unavailable and policy allows bypass", async () => {
    const services = createFakeServices();
    const config = {
      ...createTestConfig(),
      malwareScanFailClosed: false
    };
    const scanner: MalwareScanService = {
      async scan() {
        throw new Error("scanner timeout");
      },
      async close() {}
    };
    const server = await startApiTestServer({ ...services, config, malwareScan: scanner });
    closers.push(server.close);

    const objectKey = "tmp/seller_scan/input/2026/02/23/resize/bypass.png";
    services.storage.setObject(objectKey, "image/png", fakePngBytes("clean"));

    const response = await fetch(`${server.baseUrl}/api/uploads/complete`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ subjectId: "seller_scan", objectKey })
    });

    expect(response.status).toBe(200);
  });
});
